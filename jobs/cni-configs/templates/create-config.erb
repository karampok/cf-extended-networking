#!/bin/bash

set -eu
mkdir -p /var/vcap/data/cni-configs
opt=$( curl -Lks  127.0.0.1:23954| python -m json.tool |grep overlay_subnet|awk  '{print $2}'  )
if [ -z $opt ]; then
  exit 1
fi

SUBNET="${opt//\"}"
cat > /var/vcap/data/cni-configs/chained.conflist <<EOF
  {
  "cniVersion": "0.3.1",
  "name": "mynet",
  "plugins": [
     {
        "type": "bridge",
        "bridge": "mynet0",
        "isGateway": true,
        "ipMasq": false,
        "hairpinMode": false,
        "ipam": {
            "type": "host-local",
            "subnet": "$SUBNET",
            "routes": [
                { "dst": "0.0.0.0/0" }
            ],
         "dataDir": "/run/ipam-out-net"
        },
        "dns": {
          "nameservers": [ "8.8.8.8" ]
        }
    },
    {
      "type": "portmap",
      "capabilities": {"portMappings": true},
      "snat": false
      },
    {
      "type":"diktyo",
      "debug":true,
      "capabilities": {"portMappings": true},
      "debugDir": "/tmp/net-debug"
    }
  ]
}
EOF
