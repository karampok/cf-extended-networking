#!/bin/bash

set -eu
#mkdir -p /var/vcap/data/cni-configs
#opt=$( curl -Lks  127.0.0.1:23954| python -m json.tool |grep overlay_subnet|awk  '{print $2}'  )
#if [ -z $opt ]; then
#  exit 1
#fi
#
#this is a comment
#SUBNET="${opt//\"}"
#cp /var/vcap/packages/cni/bin/silk-cni /var/vcap/packages/cni-plugins/bin/silk-cni
SUBNET="10.200.$(hostname -I | cut -d' ' -f1 | cut -d'.' -f4).0/24"
cat > /var/vcap/data/cni-configs/chained.conflist <<EOF
  {
  "cniVersion": "0.3.1",
  "name": "mynet",
  "plugins": [
     {
        "type": "bridge",
        "bridge": "mynet0",
        "isGateway": true,
        "ipMasq": true,
        "hairpinMode": false,
        "ipam": {
            "type": "host-local",
            "subnet": "$SUBNET",
            "routes": [
                { "dst": "0.0.0.0/0" }
            ],
         "dataDir": "/run/ipam-out-net"
        },
        "dns": {
          "nameservers": [ "8.8.8.8" ]
        }
    },
    {
      "type":"ipmasq",
      "tag":"CNI-SNAT-X",
      "capabilities": {"masqEntries": true}
    },
    {
      "type": "portmap",
      "capabilities": {"portMappings": true},
      "snat": false
      },
      {
      "type":"noop",
      "debug":true,
      "capabilities": {
           "portMappings": true,
           "metadata": true,
           "masqEntries": true
      },
      "debugDir": "/var/vcap/data/cni-configs/net-debug"
    }
  ]
}
EOF


cat > /var/vcap/data/cni-configs/masqrules.config <<EOF
97cec793-4aff-4df8-9e14-ed3ccd16956c=7000-7100
6dafd282-3a10-45df-a38e-5b4470208844=5000-5100
EOF

